"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _export(target,all){for(var name in all)Object.defineProperty(target,name,{enumerable:true,get:all[name]})}_export(exports,{getFileStats:function(){return getFileStats},sendFile:function(){return sendFile},serveStatic:function(){return serveStatic},streamFile:function(){return streamFile}});const _path=_interop_require_default(require("path"));const _mrmime=require("mrmime");const _fs=require("fs");function _interop_require_default(obj){return obj&&obj.__esModule?obj:{default:obj}}function serveStatic(dir){return(req,res)=>{try{const url=req.getUrl().slice(1)||"index.html";const filePath=_path.default.resolve(dir,url);const isFileOutsideDir=filePath.indexOf(_path.default.resolve(dir))!==0;if(isFileOutsideDir){return res.writeStatus("403").res.end()}const fileStats=getFileStats(filePath);if(!fileStats){return res.writeStatus("404").end()}const{contentType,lastModified}=fileStats;const ifModifiedSince=req.getHeader("if-modified-since");if(ifModifiedSince===lastModified){return res.writeStatus("304").res.end()}res.writeHeader("Content-Type",contentType);res.writeHeader("Last-Modified",lastModified);streamFile(res,fileStats)}catch(error){res.writeStatus("500").end()}}}function getFileStats(filePath){const stats=(0,_fs.lstatSync)(filePath,{throwIfNoEntry:false});if(!stats||stats.isDirectory()){return}const fileExtension=_path.default.extname(filePath);const contentType=(0,_mrmime.lookup)(fileExtension)||"application/octet-stream";const{mtime,size}=stats;const lastModified=mtime.toUTCString();return{filePath,lastModified,size,contentType}}function toArrayBuffer(buffer){return buffer.buffer.slice(buffer.byteOffset,buffer.byteOffset+buffer.byteLength)}function streamFile(res,fileStats){const filePath=fileStats?.filePath;const size=fileStats?.size;if(!filePath||!size){return res.writeStatus("404").end("File not found")}const readStream=(0,_fs.createReadStream)(filePath);function destroyReadStream(){!readStream.destroyed&&readStream.destroy()}function onError(error){destroyReadStream();throw error}function onDataChunk(chunk){const arrayBufferChunk=toArrayBuffer(chunk);res.cork(()=>{const lastOffset=res.getWriteOffset();const[ok,done]=res.tryEnd(arrayBufferChunk,size);if(!done&&!ok){readStream.pause();res.onWritable(offset=>{const[ok,done]=res.tryEnd(arrayBufferChunk.slice(offset-lastOffset),size);if(!done&&ok){readStream.resume()}return ok})}})}res.onAborted(destroyReadStream);readStream.on("data",onDataChunk).on("error",onError).on("end",destroyReadStream)}function sendFile(req,res,filePath){const fileStats=getFileStats(filePath);if(!fileStats){return res.writeStatus("404").end("File not found")}const{contentType,lastModified}=fileStats;const ifModifiedSince=req.getHeader("if-modified-since");if(ifModifiedSince===lastModified){return res.writeStatus("304").end()}res.writeHeader("Content-Type",contentType);res.writeHeader("Last-Modified",lastModified);streamFile(res,fileStats)}
//# sourceMappingURL=file.js.map