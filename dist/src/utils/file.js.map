{"version":3,"sources":["../../../src/utils/file.ts"],"sourcesContent":["import path from 'path'\nimport { lookup } from 'mrmime'\nimport { createReadStream, lstatSync, Stats } from 'fs'\nimport { HttpResponse, HttpRequest } from 'uWebSockets.js'\n\nexport function serveStatic(dir: string) {\n  return (req: HttpRequest, res: HttpResponse) => {\n    try {\n      const url = req.getUrl().slice(1) || 'index.html'\n      const filePath = path.resolve(dir, url)\n      const isFileOutsideDir = filePath.indexOf(path.resolve(dir)) !== 0\n\n      if (isFileOutsideDir) {\n        return res.writeStatus('403').res.end()\n      }\n\n      const fileStats = getFileStats(filePath)\n\n      if (!fileStats) {\n        return res.writeStatus('404').end()\n      }\n\n      const { contentType, lastModified } = fileStats\n      const ifModifiedSince = req.getHeader('if-modified-since')\n\n      if (ifModifiedSince === lastModified) {\n        return res.writeStatus('304').res.end()\n      }\n\n      res.writeHeader('Content-Type', contentType)\n      res.writeHeader('Last-Modified', lastModified)\n\n      streamFile(res, fileStats)\n    } catch (error: any) {\n      res.writeStatus('500').end()\n    }\n  }\n}\n\nexport function getFileStats(filePath: string) {\n  const stats: Stats | undefined = lstatSync(filePath, { throwIfNoEntry: false })\n\n  if (!stats || stats.isDirectory()) {\n    return\n  }\n\n  const fileExtension = path.extname(filePath)\n  const contentType = lookup(fileExtension) || 'application/octet-stream'\n  const { mtime, size } = stats\n  const lastModified = mtime.toUTCString()\n\n  return { filePath, lastModified, size, contentType }\n}\n\nfunction toArrayBuffer(buffer: Buffer) {\n  return buffer.buffer.slice(buffer.byteOffset, buffer.byteOffset + buffer.byteLength)\n}\n\nexport function streamFile(res: HttpResponse, fileStats: ReturnType<typeof getFileStats>) {\n  const filePath = fileStats?.filePath\n  const size = fileStats?.size\n\n  if (!filePath || !size) {\n    return res.writeStatus('404').end('File not found')\n  }\n\n  const readStream = createReadStream(filePath)\n  function destroyReadStream() {\n    !readStream.destroyed && readStream.destroy()\n  }\n\n  function onError(error: Error) {\n    destroyReadStream()\n    throw error\n  }\n\n  function onDataChunk(chunk: Buffer) {\n    const arrayBufferChunk = toArrayBuffer(chunk)\n\n    res.cork(() => {\n      const lastOffset = res.getWriteOffset()\n      const [ok, done] = res.tryEnd(arrayBufferChunk, size!)\n\n      if (!done && !ok) {\n        readStream.pause()\n\n        res.onWritable((offset) => {\n          const [ok, done] = res.tryEnd(arrayBufferChunk.slice(offset - lastOffset), size!)\n\n          if (!done && ok) {\n            readStream.resume()\n          }\n\n          return ok\n        })\n      }\n    })\n  }\n\n  res.onAborted(destroyReadStream)\n  readStream.on('data', onDataChunk).on('error', onError).on('end', destroyReadStream)\n}\n\nexport function sendFile(req: HttpRequest, res: HttpResponse, filePath: string) {\n  const fileStats = getFileStats(filePath)\n\n  if (!fileStats) {\n    return res.writeStatus('404').end('File not found')\n  }\n\n  const { contentType, lastModified } = fileStats\n  const ifModifiedSince = req.getHeader('if-modified-since')\n\n  if (ifModifiedSince === lastModified) {\n    return res.writeStatus('304').end()\n  }\n\n  res.writeHeader('Content-Type', contentType)\n  res.writeHeader('Last-Modified', lastModified)\n\n  streamFile(res, fileStats)\n}\n"],"names":["getFileStats","sendFile","serveStatic","streamFile","dir","req","res","url","getUrl","slice","filePath","path","resolve","isFileOutsideDir","indexOf","writeStatus","end","fileStats","contentType","lastModified","ifModifiedSince","getHeader","writeHeader","error","stats","lstatSync","throwIfNoEntry","isDirectory","fileExtension","extname","lookup","mtime","size","toUTCString","toArrayBuffer","buffer","byteOffset","byteLength","readStream","createReadStream","destroyReadStream","destroyed","destroy","onError","onDataChunk","chunk","arrayBufferChunk","cork","lastOffset","getWriteOffset","ok","done","tryEnd","pause","onWritable","offset","resume","onAborted","on"],"mappings":"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"}