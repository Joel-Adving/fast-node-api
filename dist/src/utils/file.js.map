{"version":3,"sources":["../../../src/utils/file.ts"],"sourcesContent":["import path from 'path'\nimport { lookup } from 'mrmime'\nimport { createReadStream, lstatSync, Stats } from 'fs'\nimport { HttpResponse, HttpRequest } from 'uWebSockets.js'\n\nexport function serveStatic(dir: string) {\n  return (req: HttpRequest, res: HttpResponse) => {\n    try {\n      const url = req.getUrl().slice(1) || 'index.html'\n      const filePath = path.resolve(dir, url)\n      const isFileOutsideDir = filePath.indexOf(path.resolve(dir)) !== 0\n\n      if (isFileOutsideDir) {\n        return res.writeStatus('403').res.end()\n      }\n\n      const fileStats = getFileStats(filePath)\n\n      if (!fileStats) {\n        return res.writeStatus('404').end()\n      }\n\n      const { contentType, lastModified } = fileStats\n      const ifModifiedSince = req.getHeader('if-modified-since')\n\n      if (ifModifiedSince === lastModified) {\n        return res.writeStatus('304').res.end()\n      }\n\n      res.writeHeader('Content-Type', contentType)\n      res.writeHeader('Last-Modified', lastModified)\n\n      streamFile(res, fileStats)\n    } catch (error: any) {\n      res.writeStatus('500').end()\n    }\n  }\n}\n\nexport function getFileStats(filePath: string) {\n  const stats: Stats | undefined = lstatSync(filePath, { throwIfNoEntry: false })\n\n  if (!stats || stats.isDirectory()) {\n    return\n  }\n\n  const fileExtension = path.extname(filePath)\n  const contentType = lookup(fileExtension) || 'application/octet-stream'\n  const { mtime, size } = stats\n  const lastModified = mtime.toUTCString()\n\n  return { filePath, lastModified, size, contentType }\n}\n\nfunction toArrayBuffer(buffer: Buffer) {\n  return buffer.buffer.slice(buffer.byteOffset, buffer.byteOffset + buffer.byteLength)\n}\n\nexport function streamFile(res: HttpResponse, fileStats: ReturnType<typeof getFileStats>) {\n  const filePath = fileStats?.filePath\n  const size = fileStats?.size\n\n  if (!filePath || !size) {\n    return res.writeStatus('404').end('File not found')\n  }\n\n  const readStream = createReadStream(filePath)\n  function destroyReadStream() {\n    !readStream.destroyed && readStream.destroy()\n  }\n\n  function onError(error: Error) {\n    destroyReadStream()\n    throw error\n  }\n\n  function onDataChunk(chunk: Buffer) {\n    const arrayBufferChunk = toArrayBuffer(chunk)\n\n    res.cork(() => {\n      const lastOffset = res.getWriteOffset()\n      const [ok, done] = res.tryEnd(arrayBufferChunk, size!)\n\n      if (!done && !ok) {\n        readStream.pause()\n\n        res.onWritable((offset) => {\n          const [ok, done] = res.tryEnd(arrayBufferChunk.slice(offset - lastOffset), size!)\n\n          if (!done && ok) {\n            readStream.resume()\n          }\n\n          return ok\n        })\n      }\n    })\n  }\n\n  res.onAborted(destroyReadStream)\n  readStream.on('data', onDataChunk).on('error', onError).on('end', destroyReadStream)\n}\n\nexport function sendFile(req: HttpRequest, res: HttpResponse, filePath: string) {\n  const fileStats = getFileStats(filePath)\n\n  if (!fileStats) {\n    return res.writeStatus('404').end('File not found')\n  }\n\n  const { contentType, lastModified } = fileStats\n  const ifModifiedSince = req.getHeader('if-modified-since')\n\n  if (ifModifiedSince === lastModified) {\n    return res.writeStatus('304').end()\n  }\n\n  res.writeHeader('Content-Type', contentType)\n  res.writeHeader('Last-Modified', lastModified)\n\n  streamFile(res, fileStats)\n}\n"],"names":["path","lookup","createReadStream","lstatSync","serveStatic","dir","req","res","url","getUrl","slice","filePath","resolve","isFileOutsideDir","indexOf","writeStatus","end","fileStats","getFileStats","contentType","lastModified","ifModifiedSince","getHeader","writeHeader","streamFile","error","stats","throwIfNoEntry","isDirectory","fileExtension","extname","mtime","size","toUTCString","toArrayBuffer","buffer","byteOffset","byteLength","readStream","destroyReadStream","destroyed","destroy","onError","onDataChunk","chunk","arrayBufferChunk","cork","lastOffset","getWriteOffset","ok","done","tryEnd","pause","onWritable","offset","resume","onAborted","on","sendFile"],"mappings":"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"}