"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _export(target,all){for(var name in all)Object.defineProperty(target,name,{enumerable:true,get:all[name]})}_export(exports,{App:function(){return App},Router:function(){return Router}});const _uWebSockets=_interop_require_default(require("uWebSockets.js"));const _file=require("./utils/file.js");const _uwsutils=require("./utils/uws-utils.js");function _define_property(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _interop_require_default(obj){return obj&&obj.__esModule?obj:{default:obj}}class App{handleRequest(method,path,handler){this.app[method].call(this.app,path,(res,req)=>{res.cork(()=>{this.patchRequestResponse(req,res);try{this.executeMiddlewares(req,res,this.middlewares,()=>handler(req,res))}catch(error){this.logger.error(error);if(!res.done){res.writeStatus("500 Internal Server Error").end("Internal Server Error")}}})})}patchRequestResponse(req,res){req.body=async()=>(0,_uwsutils.parseBody)(res);req.getCookie=name=>(0,_uwsutils.getCookie)(req,res,name);res._end=res.end;res.onAborted(()=>{res.done=true;if(res.abortEvents){res.abortEvents.forEach(f=>f())}});res.onAborted=handler=>{res.abortEvents=res.abortEvents||[];res.abortEvents.push(handler);return res};res.end=body=>{if(res.done){this.logger.warn("uWS DEBUG: Called end after done");return res}res.done=true;res._end(body);return res};res.send=body=>{res.end(body)};res.status=code=>{res.writeStatus(String(code));return res};res.header=(key,value)=>{res.writeHeader(key,value);return res};res.json=body=>{res.writeHeader("Content-Type","application/json");try{res.end(JSON.stringify(body))}catch(error){throw new Error("Failed to stringify JSON",{cause:error})}};res.sendFile=filePath=>(0,_file.sendFile)(req,res,filePath)}executeMiddlewares(req,res,handlers,finalHandler){const next=index=>{if(index<handlers.length){handlers[index](req,res,()=>next(index+1))}else{finalHandler()}};next(0)}use(handler){this.middlewares.push(handler);return this}get(path,handler){this.handleRequest("get",path,handler);return this}post(path,handler){this.handleRequest("post",path,handler);return this}patch(path,handler){this.handleRequest("patch",path,handler);return this}put(path,handler){this.handleRequest("put",path,handler);return this}delete(path,handler){this.handleRequest("del",path,handler);return this}options(path,handler){this.handleRequest("options",path,handler)}websocket(pattern,behavior){this.app.ws(pattern,behavior)}group(path,router){router.routes.forEach(route=>{this.handleRequest(route.method,path+route.path,(req,res)=>{this.executeMiddlewares(req,res,router.middlewares,()=>route.handler(req,res,()=>{}))})});return this}listen(port,cb){this.app.listen(port,token=>{if(token){cb(token)}else{throw new Error("Failed to listen to port")}})}close(){this.app.close()}constructor({logger}={}){_define_property(this,"app",void 0);_define_property(this,"logger",void 0);_define_property(this,"middlewares",[]);this.app=_uWebSockets.default.App();this.logger=logger||console}}class Router{addRoute(method,path,handler){this.routes.push({method,path,handler})}use(handler){this.middlewares.push(handler);return this}get(path,handler){this.addRoute("get",path,handler);return this}post(path,handler){this.addRoute("post",path,handler);return this}patch(path,handler){this.addRoute("patch",path,handler);return this}put(path,handler){this.addRoute("put",path,handler);return this}delete(path,handler){this.addRoute("del",path,handler);return this}constructor(){_define_property(this,"routes",[]);_define_property(this,"middlewares",[])}}
//# sourceMappingURL=app.js.map