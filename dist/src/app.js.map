{"version":3,"sources":["../../src/app.ts"],"sourcesContent":["import uWS, { us_listen_socket } from 'uWebSockets.js'\nimport { sendFile } from './utils/file'\nimport { HttpMethod, IApp, ILogger, Middleware, Request, Response } from './types'\nimport { getCookie, parseBody } from './utils/uws-utils'\n\nexport class App {\n  app: IApp\n  logger: ILogger\n  middlewares: Middleware[] = []\n\n  constructor({ logger }: { logger?: ILogger } = {}) {\n    this.app = uWS.App() as IApp\n    this.logger = logger || console\n  }\n\n  private handleRequest(method: HttpMethod, path: string, handler: (req: Request, res: Response) => void) {\n    ;(this.app[method] as (path: string, handler: (res: Response, req: Request) => void) => void).call(\n      this.app,\n      path,\n      (res, req) => {\n        res.cork(() => {\n          this.patchRequestResponse(req, res)\n          try {\n            this.executeMiddlewares(req, res, this.middlewares, () => handler(req, res))\n          } catch (error) {\n            this.logger.error(error)\n            if (!res.done) {\n              res.writeStatus('500 Internal Server Error').end('Internal Server Error')\n            }\n          }\n        })\n      }\n    )\n  }\n\n  private patchRequestResponse(req: Request, res: Response) {\n    req.body = async <T>() => parseBody<T>(res)\n    req.getCookie = (name: string) => getCookie(req, res, name)\n\n    res._end = res.end\n\n    res.onAborted(() => {\n      res.done = true\n      if (res.abortEvents) {\n        res.abortEvents.forEach((f: () => void) => f())\n      }\n    })\n\n    res.onAborted = (handler) => {\n      res.abortEvents = res.abortEvents || []\n      res.abortEvents.push(handler)\n      return res\n    }\n\n    res.end = (body) => {\n      if (res.done) {\n        this.logger.warn('uWS DEBUG: Called end after done')\n        return res\n      }\n      res.done = true\n      res._end(body)\n      return res\n    }\n\n    res.send = (body) => {\n      res.end(body)\n    }\n\n    res.status = (code) => {\n      res.writeStatus(String(code))\n      return res\n    }\n\n    res.header = (key, value) => {\n      res.writeHeader(key, value)\n      return res\n    }\n\n    res.json = (body) => {\n      res.writeHeader('Content-Type', 'application/json')\n      try {\n        res.end(JSON.stringify(body))\n      } catch (error) {\n        throw new Error('Failed to stringify JSON', { cause: error })\n      }\n    }\n\n    res.sendFile = (filePath) => sendFile(req, res, filePath)\n  }\n\n  private executeMiddlewares(req: Request, res: Response, handlers: Middleware[], finalHandler: () => void) {\n    const next = (index: number) => {\n      if (index < handlers.length) {\n        handlers[index](req, res, () => next(index + 1))\n      } else {\n        finalHandler()\n      }\n    }\n    next(0)\n  }\n\n  use(handler: Middleware) {\n    this.middlewares.push(handler)\n    return this\n  }\n\n  get(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('get', path, handler)\n    return this\n  }\n\n  post(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('post', path, handler)\n    return this\n  }\n\n  patch(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('patch', path, handler)\n    return this\n  }\n\n  put(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('put', path, handler)\n    return this\n  }\n\n  delete(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('del', path, handler)\n    return this\n  }\n\n  options(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('options', path, handler)\n  }\n\n  websocket(pattern: uWS.RecognizedString, behavior: uWS.WebSocketBehavior<unknown>) {\n    this.app.ws(pattern, behavior)\n  }\n\n  group(path: string, router: Router) {\n    router.routes.forEach((route) => {\n      this.handleRequest(route.method as HttpMethod, path + route.path, (req, res) => {\n        this.executeMiddlewares(req, res, router.middlewares, () => route.handler(req, res, () => {}))\n      })\n    })\n    return this\n  }\n\n  listen(port: number, cb: (listenSocket: us_listen_socket) => void) {\n    this.app.listen(port, (token) => {\n      if (token) {\n        cb(token)\n      } else {\n        throw new Error('Failed to listen to port')\n      }\n    })\n  }\n\n  close() {\n    this.app.close()\n  }\n}\n\nexport class Router {\n  routes: { method: string; path: string; handler: Middleware }[] = []\n  middlewares: Middleware[] = []\n\n  private addRoute(method: string, path: string, handler: Middleware) {\n    this.routes.push({ method, path, handler })\n  }\n\n  use(handler: Middleware) {\n    this.middlewares.push(handler)\n    return this\n  }\n\n  get(path: string, handler: Middleware) {\n    this.addRoute('get', path, handler)\n    return this\n  }\n\n  post(path: string, handler: Middleware) {\n    this.addRoute('post', path, handler)\n    return this\n  }\n\n  patch(path: string, handler: Middleware) {\n    this.addRoute('patch', path, handler)\n    return this\n  }\n\n  put(path: string, handler: Middleware) {\n    this.addRoute('put', path, handler)\n    return this\n  }\n\n  delete(path: string, handler: Middleware) {\n    this.addRoute('del', path, handler)\n    return this\n  }\n}\n"],"names":["App","Router","handleRequest","method","path","handler","app","call","res","req","cork","patchRequestResponse","executeMiddlewares","middlewares","error","logger","done","writeStatus","end","body","parseBody","getCookie","name","_end","onAborted","abortEvents","forEach","f","push","warn","send","status","code","String","header","key","value","writeHeader","json","JSON","stringify","Error","cause","sendFile","filePath","handlers","finalHandler","next","index","length","use","get","post","patch","put","delete","options","websocket","pattern","behavior","ws","group","router","routes","route","listen","port","cb","token","close","constructor","uWS","console","addRoute"],"mappings":"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"}