{"version":3,"sources":["../../src/app.ts"],"sourcesContent":["import uWS, { us_listen_socket } from 'uWebSockets.js'\nimport { sendFile } from './utils/file'\nimport { HttpMethod, IApp, ILogger, Middleware, Request, Response } from './types'\nimport { getCookie, parseBody } from './utils/uws-utils'\n\nexport class App {\n  app: IApp\n  logger: ILogger\n  middlewares: Middleware[] = []\n\n  constructor({ logger }: { logger?: ILogger } = {}) {\n    this.app = uWS.App() as IApp\n    this.logger = logger || console\n  }\n\n  private handleRequest(method: HttpMethod, path: string, handler: (req: Request, res: Response) => void) {\n    ;(this.app[method] as (path: string, handler: (res: Response, req: Request) => void) => void).call(\n      this.app,\n      path,\n      (res, req) => {\n        res.cork(() => {\n          this.patchRequestResponse(req, res)\n          try {\n            this.executeMiddlewares(req, res, this.middlewares, () => handler(req, res))\n          } catch (error) {\n            this.logger.error(error)\n            if (!res.done) {\n              res.writeStatus('500 Internal Server Error').end('Internal Server Error')\n            }\n          }\n        })\n      }\n    )\n  }\n\n  private patchRequestResponse(req: Request, res: Response) {\n    req.body = async <T>() => parseBody<T>(res)\n    req.getCookie = (name: string) => getCookie(req, res, name)\n\n    res._end = res.end\n\n    res.onAborted(() => {\n      res.done = true\n      if (res.abortEvents) {\n        res.abortEvents.forEach((f: () => void) => f())\n      }\n    })\n\n    res.onAborted = (handler) => {\n      res.abortEvents = res.abortEvents || []\n      res.abortEvents.push(handler)\n      return res\n    }\n\n    res.end = (body) => {\n      if (res.done) {\n        this.logger.warn('uWS DEBUG: Called end after done')\n        return res\n      }\n      res.done = true\n      res._end(body)\n      return res\n    }\n\n    res.send = (body) => {\n      res.end(body)\n    }\n\n    res.status = (code) => {\n      res.writeStatus(String(code))\n      return res\n    }\n\n    res.header = (key, value) => {\n      res.writeHeader(key, value)\n      return res\n    }\n\n    res.json = (body) => {\n      res.writeHeader('Content-Type', 'application/json')\n      try {\n        res.end(JSON.stringify(body))\n      } catch (error) {\n        throw new Error('Failed to stringify JSON', { cause: error })\n      }\n    }\n\n    res.sendFile = (filePath) => sendFile(req, res, filePath)\n  }\n\n  private executeMiddlewares(req: Request, res: Response, handlers: Middleware[], finalHandler: () => void) {\n    const next = (index: number) => {\n      if (index < handlers.length) {\n        handlers[index](req, res, () => next(index + 1))\n      } else {\n        finalHandler()\n      }\n    }\n    next(0)\n  }\n\n  use(handler: Middleware) {\n    this.middlewares.push(handler)\n    return this\n  }\n\n  get(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('get', path, handler)\n    return this\n  }\n\n  post(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('post', path, handler)\n    return this\n  }\n\n  patch(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('patch', path, handler)\n    return this\n  }\n\n  put(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('put', path, handler)\n    return this\n  }\n\n  delete(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('del', path, handler)\n    return this\n  }\n\n  options(path: string, handler: (req: Request, res: Response) => void) {\n    this.handleRequest('options', path, handler)\n  }\n\n  websocket(pattern: uWS.RecognizedString, behavior: uWS.WebSocketBehavior<unknown>) {\n    this.app.ws(pattern, behavior)\n  }\n\n  group(path: string, router: Router) {\n    router.routes.forEach((route) => {\n      this.handleRequest(route.method as HttpMethod, path + route.path, (req, res) => {\n        this.executeMiddlewares(req, res, router.middlewares, () => route.handler(req, res, () => {}))\n      })\n    })\n    return this\n  }\n\n  listen(port: number, cb: (listenSocket: us_listen_socket) => void) {\n    this.app.listen(port, (token) => {\n      if (token) {\n        cb(token)\n      } else {\n        throw new Error('Failed to listen to port')\n      }\n    })\n  }\n\n  close() {\n    this.app.close()\n  }\n}\n\nexport class Router {\n  routes: { method: string; path: string; handler: Middleware }[] = []\n  middlewares: Middleware[] = []\n\n  private addRoute(method: string, path: string, handler: Middleware) {\n    this.routes.push({ method, path, handler })\n  }\n\n  use(handler: Middleware) {\n    this.middlewares.push(handler)\n    return this\n  }\n\n  get(path: string, handler: Middleware) {\n    this.addRoute('get', path, handler)\n    return this\n  }\n\n  post(path: string, handler: Middleware) {\n    this.addRoute('post', path, handler)\n    return this\n  }\n\n  patch(path: string, handler: Middleware) {\n    this.addRoute('patch', path, handler)\n    return this\n  }\n\n  put(path: string, handler: Middleware) {\n    this.addRoute('put', path, handler)\n    return this\n  }\n\n  delete(path: string, handler: Middleware) {\n    this.addRoute('del', path, handler)\n    return this\n  }\n}\n"],"names":["uWS","sendFile","getCookie","parseBody","App","app","logger","middlewares","constructor","console","handleRequest","method","path","handler","call","res","req","cork","patchRequestResponse","executeMiddlewares","error","done","writeStatus","end","body","name","_end","onAborted","abortEvents","forEach","f","push","warn","send","status","code","String","header","key","value","writeHeader","json","JSON","stringify","Error","cause","filePath","handlers","finalHandler","next","index","length","use","get","post","patch","put","delete","options","websocket","pattern","behavior","ws","group","router","routes","route","listen","port","cb","token","close","Router","addRoute"],"mappings":"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"}